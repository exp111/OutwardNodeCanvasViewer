<html>

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <style>
        #cy {
            width: 100%;
            height: 90%;
            display: block;
        }

        #header {
            height: 10%;
            display: block;
        }
    </style>

</head>

<body>
    <div id="header">
        <!-- TODO: force these into one line -->
        <select id="quests" onchange="loadFromFile(this.value)">
            <option value="Placeholder">
        </select>
        <select id="dialogues" onchange="loadFromFile(this.value)">
            <option value="Placeholder">
        </select>
        <select id="behaviourTrees" onchange="loadFromFile(this.value)">
            <option value="Placeholder">
        </select>
        <input id="eventSearch" list="events" type="searach" placeholder="Search for events..."/>
        <button onclick="searchSelect(document.getElementById('eventSearch').value)">Load</button>
        <datalist id="events"></datalist>
        <select id="eventSelect" onchange="loadFromFile(this.value)">
            <option value="Placeholder"></option>
        </select>
    </div>
    <div id="cy"></div>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cytoscape/3.23.0/cytoscape.min.js"
        integrity="sha512-gEWKnYYa1/1c3jOuT9PR7NxiVI1bwn02DeJGsl+lMVQ1fWMNvtjkjxIApTdbJ/wcDjQmbf+McWahXwipdC9bGA=="
        crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="data.js"></script>
    <script src="nodes.js"></script>
    <script>
        // Clears the children of a element (like a select tag)
        clearChildren = function (parent) {
            var childArray = parent.children;
            var cL = childArray.length;
            while (cL > 0) {
                cL--;
                parent.removeChild(childArray[cL]);
            }
        };

        var graphs = [];
        var events = [];
        var eventIndex = [];
        // INFO: no tooltips, weird layout
        loadFiles().then((files) => {
            graphs = files;
            let quests = document.getElementById("quests");
            clearChildren(quests);
            graphs.Quests.forEach((quest) => {
                quests.append(new Option(quest.Name, quest.Path, false, false));
            });

            let dialogues = document.getElementById("dialogues");
            clearChildren(dialogues);
            graphs.Dialogues.forEach((dialogue) => {
                dialogues.append(new Option(dialogue.Name, dialogue.Path, false, false));
            });

            let trees = document.getElementById("behaviourTrees");
            clearChildren(trees);
            graphs.BehaviourTrees.forEach((tree) => {
                trees.append(new Option(tree.Name, tree.Path, false, false));
            });
        });

        loadEvents().then((ev) => {
            events = ev;
            let eventsSelect = document.getElementById("events");
            clearChildren(eventsSelect);
            events.forEach((event) => {
                eventsSelect.append(new Option(event.EventName, event.EventUID, false, false));
            });
        });

        loadEventIndex().then((index) => 
        {
            eventIndex = index;
        });

        function searchSelect(eventUID)
        {
            console.log("searchSelect(" + eventUID + ")");
            // check if event is in list
            let event = null;
            for (let i = 0; i < events.length; i++)
            {
                if (events[i].EventUID == eventUID)
                {
                    event = events[i];
                    break;
                }
            }

            if (event == null)
            {
                console.log("No event found for " + eventUID);
                return;
            }

            console.log("Found " + event.EventName);

            let eventSelect = document.getElementById("eventSelect");
            clearChildren(eventSelect);
            //  find files that contain event
            for (let i = 0; i < eventIndex.length; i++)
            {
                if (eventIndex[i].Name == eventUID)
                {
                    let index = eventIndex[i];
                    index.Files.forEach((file) =>
                    {
                        eventSelect.append(new Option(file, file, false, false));
                    });
                    
                    break;
                }
            }
        }

        function draw(json) {
            var cyto = {
                container: document.getElementById('cy'), // container to render in

                elements: [], // list of graph elements to start with

                style: // the stylesheet for the graph
                    [{
                            selector: 'node',
                            style: {
                                'background-color': '#666',
                                'label': 'data(label)',
                                "text-wrap": "wrap"
                            }
                        },
                        {
                            selector: 'edge',
                            style: {
                                'width': 3,
                                'line-color': '#ccc',
                                'target-arrow-color': '#ccc',
                                'target-arrow-shape': 'triangle',
                                'curve-style': 'bezier',
                                "label": "data(label)",
                                "text-wrap": "wrap"
                            }
                        }
                    ],

                layout: {
                    name: 'breadthfirst',
                    fit: true,
                    directed: true,
                    avoidOverlap: true
                }
            };
            json.nodes.forEach((node) => {
                //TODO: summary info (action types) in label, full info (detailed) in tooltip
                var text = getNodeText(node);
                cyto.elements.push({
                    data: {
                        id: node.$id,
                        label: text
                    }
                });
            });
            json.connections.forEach((connection) => {
                var text = getEdgeText(connection);
                cyto.elements.push({
                    data: {
                        source: connection._sourceNode.$ref,
                        target: connection._targetNode.$ref,
                        label: text
                    }
                });
            });

            var cy = cytoscape(cyto);
        }

        function loadFromFile(path) {
            loadJson(path).then((json) => {
                if (json != null)
                    draw(json)
            });
        }
        loadFromFile("quests/7011000_Neutral_RealIntro_Quest.json");
    </script>
</body>

</html>
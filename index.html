<html>

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <style>
        #cy {
            width: 100%;
            height: 90%;
            display: block;
        }

        #header {
            height: 10%;
            display: block;
        }
    </style>

</head>

<body>
    <div id="header">
        <!-- TODO: force these into one line -->
        <select id="quests" onchange="loadFromFile(this.value)">
            <option value="Placeholder">
        </select>
        <select id="dialogues" onchange="loadFromFile(this.value)">
            <option value="Placeholder">
        </select>
        <select id="behaviourTrees" onchange="loadFromFile(this.value)">
            <option value="Placeholder">
        </select>
        <input id="eventSearch" list="events" type="searach" placeholder="Search for events..." />
        <button onclick="searchSelect(document.getElementById('eventSearch').value)">Load</button>
        <datalist id="events"></datalist>
        <select id="eventSelect" onchange="loadFromFile(this.value)">
            <option value="Placeholder"></option>
        </select>
    </div>
    <div id="cy"></div>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cytoscape/3.23.0/cytoscape.min.js"
        integrity="sha512-gEWKnYYa1/1c3jOuT9PR7NxiVI1bwn02DeJGsl+lMVQ1fWMNvtjkjxIApTdbJ/wcDjQmbf+McWahXwipdC9bGA=="
        crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="data.js"></script>
    <script src="nodes.js"></script>
    <script>
        // Clears the children of a element (like a select tag)
        clearChildren = function (parent) {
            var childArray = parent.children;
            var cL = childArray.length;
            while (cL > 0) {
                cL--;
                parent.removeChild(childArray[cL]);
            }
        };

        var Global = {
            graphs: [],
            events: {},
            eventIndex: {},
        };
        // INFO: no tooltips, weird layout

        // load tree files and put them into the selects
        loadFiles().then((files) => {
            Global.graphs = files;

            // Add quests to select
            let quests = document.getElementById("quests");
            clearChildren(quests);
            Global.graphs.Quests.forEach((quest) => {
                quests.append(new Option(quest.Name, quest.Path, false, false));
            });

            // Add dialogues to select
            let dialogues = document.getElementById("dialogues");
            clearChildren(dialogues);
            Global.graphs.Dialogues.forEach((dialogue) => {
                dialogues.append(new Option(dialogue.Name, dialogue.Path, false, false));
            });

            // Add behaviour trees to select
            let trees = document.getElementById("behaviourTrees");
            clearChildren(trees);
            Global.graphs.BehaviourTrees.forEach((tree) => {
                trees.append(new Option(tree.Name, tree.Path, false, false));
            });
        });

        // Load events and add them to the search
        loadEvents().then((ev) => {
            Global.events = ev;
            let eventsSelect = document.getElementById("events");
            clearChildren(eventsSelect);
            // Add events to event search list
            for (let [uid, event] of Object.entries(Global.events))
            {
                eventsSelect.append(new Option(event.Name, uid, false, false));
            };
        });

        // Load Event index so it can be used later on for the search
        loadEventIndex().then((index) => {
            Global.eventIndex = index;
        });

        //TODO: not working scripts: Dialogue_RissaAberdeen_Neut_Prequest, Dialogue_BellyTheMerchant_BC_AshGiant

        function searchSelect(eventUID) {
            console.log("searchSelect(" + eventUID + ")");
            // check if event is in list
            let event = Global.events[eventUID];
            if (event == null) {
                console.log("No event found for " + eventUID);
                return;
            }
            //TODO: remove this?

            console.log("Found " + event.EventName);

            let eventSelect = document.getElementById("eventSelect");
            clearChildren(eventSelect);
            //  find files that contain event
            let index = Global.eventIndex[eventUID];
            if (index == null) {
                console.log("No event with uid " + eventUID);
                return;
            }
            index.forEach((file) => {
                eventSelect.append(new Option(file, file, false, false));
            });
        }

        function draw(json) {
            var cyto = {
                container: document.getElementById('cy'), // container to render in

                elements: [], // list of graph elements to start with

                style: // the stylesheet for the graph
                    [{
                            selector: 'node',
                            style: {
                                'background-color': '#666',
                                'label': 'data(label)',
                                "text-wrap": "wrap"
                            }
                        },
                        {
                            selector: 'edge',
                            style: {
                                'width': 3,
                                'line-color': '#ccc',
                                'target-arrow-color': '#ccc',
                                'target-arrow-shape': 'triangle',
                                'curve-style': 'bezier',
                                "label": "data(label)",
                                "text-wrap": "wrap"
                            }
                        }
                    ],

                layout: {
                    name: 'breadthfirst',
                    fit: true,
                    directed: true,
                    avoidOverlap: true
                }
            };
            // INFO: code: ParadoxNotion.Serialization.FullSerializer.fsSerializer.Internal_Deserialize
            // nodes arent defined necessarily in the top layer of json.nodes, but can also be defined when referenced (for example in NodeCanvas.DialogueTrees.GoToNode._targetNode)
            // the top layer node definition just $ref's the id
            // TODO: solution ideas: build an actual graph with real classes and and later
            let referencedNodes = {};
            let customConnections = {}; //TODO: GoTo + jumper Nodes should probably add a custom connection?
            json.nodes.forEach((node) => {
                // $ref workaround
                if (node._targetNode != null && node._targetNode.$id != null)
                {
                    console.log(`Adding target node ${node._targetNode.$id} to referencedNodes`);
                    referencedNodes[node._targetNode.$id] = node._targetNode;
                }
                if (node.$ref != null)
                {
                    console.log(`Inserting referenced node ${node.$ref}`);
                    node = referencedNodes[node.$ref];
                }
                var text = getNodeText(node);
                cyto.elements.push({
                    data: {
                        id: node.$id,
                        label: text
                    }
                });
            });
            json.connections.forEach((connection) => {
                var text = getEdgeText(connection);
                cyto.elements.push({
                    data: {
                        source: connection._sourceNode.$ref,
                        target: connection._targetNode.$ref,
                        label: text
                    }
                });
            });

            var cy = cytoscape(cyto);
        }

        // Load tree from relative data json url and draw it
        function loadFromFile(path) {
            loadJson(path).then((json) => {
                if (json != null)
                    draw(json)
            });
        }
        loadFromFile("quests/7011000_Neutral_RealIntro_Quest.json");
    </script>
</body>

</html>